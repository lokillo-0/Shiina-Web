<#include "/assets/base.html">
<div class="container">
    <!-- Mode Selector Card -->
    <div class="card">
        <div class="row m-2 m-lg-0 shiina-def-cursor justify-content-center justify-content-lg-start">
            <#include "/freemarker/selector.ftl">
            <#include "/freemarker/rx-selector.ftl">
        </div>
    </div>

    <!-- Main Clan Profile Card -->
    <div class="card rounded my-4">
        <!-- Hero Section -->
        <div class="bg-gradient rounded position-relative"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="row p-4 position-relative">
                <!-- Clan Avatar/Collage -->
                <div class="col-12 col-md-3 d-flex justify-content-center align-items-center mb-3 mb-md-0">
                    <div class="position-relative">
                        <div class="d-grid user-collage user-collage-lg rounded overflow-hidden"
                             style="width: 150px; height: 150px;">
                            <#assign count=0>
                            <img src="${avatarServer}/${clan.owner?c}" class="w-100 h-100 object-fit-cover" alt="Owner">
                            <#list members as collage>
                                <#assign count=count + 1>
                                <img src="${avatarServer}/${collage.id?c}" class="w-100 h-100 object-fit-cover" alt="Member">
                                <#if count==3><#break></#if>
                            </#list>
                            <#if count==0>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            <#elseif count==1>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            <#elseif count==2>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            </#if>
                        </div>
                    </div>
                </div>
                
                <!-- Clan Info -->
                <div class="col-12 col-md-9 d-flex flex-column justify-content-center text-white" >
                    <div class="mb-2">
                        <h1 class="display-4 fw-bold mb-2 shiina-player-name">${clan.name}</h1>
                    </div>
                    
                    <!-- Owner Info -->
                     <#assign u={ "id" : clan.owner, "name" : clan.ownerName, "country" :
                                clan.ownerCountry, "isOwner" : true }>
                                <#assign index=0>
                                    <#include "/freemarker/models/user.ftl">
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="card-body bg-body">
            <!-- Clan Actions -->
            <div class="d-flex flex-wrap gap-2 mx-1 mb-4">
                <#if clanRel??>
                    <#if clan.owner==user.id>
                        <a href="/clan/${clan.id}/settings" class="btn btn-secondary">
                            <i class="fa-solid fa-gear me-2"></i>Clan Management
                        </a>
                    </#if>
                    
                    <#if clanRel.userInThisClan>
                        <#if clan.owner!=user.id>
                            <button type="button" class="btn btn-danger" 
                                onclick="handleClanLeave('${clan.id}')">
                                <i class="fas fa-user-minus me-1"></i>Leave Clan
                            </button>
                        </#if>

                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-heart-circle-check"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Member
                            </div>
                        </span>
                    <#elseif clanRel.clanIdCheck>
                        <button type="button" class="btn btn-secondary disabled" data-bs-toggle="tooltip" 
                                title="You are already in a clan">Request joining</button>
                    <#elseif clanRel.inShClanPending>
                        <button type="button" class="btn btn-warning" 
                                onclick="handleClanJoinRequest('${clan.id}', 'REVOKE')">
                            <i class="fas fa-clock me-1"></i>Revoke request
                        </button>
                    <#elseif clanRel.inShClanDenied>
                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-shield text-danger"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Denied from joining
                            </div>
                        </span>
                    <#else>
                        <button type="button" class="btn btn-success" 
                                onclick="handleClanJoinRequest('${clan.id}', 'REQUEST')">
                            <i class="fas fa-user-plus me-1"></i>Request joining
                        </button>
                    </#if>
                    
                    <#if clan.owner==user.id>
                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-shield text-primary"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Owner
                            </div>
                        </span>
                    </#if>
                    
                    <span class="shiina-follower-count">
                        <div class="shiina-follower-count-icon">
                            <i class="fa-solid fa-hashtag"></i>
                        </div>
                        <div class="shiina-follower-count-body">
                            [${clan.tag}]
                        </div>
                    </span>
                <#else>
                    <span class="shiina-follower-count">
                        <div class="shiina-follower-count-icon">
                            <i class="fa-solid fa-hashtag"></i>
                        </div>
                        <div class="shiina-follower-count-body">
                            [${clan.tag}]
                        </div>
                    </span>
                </#if>
            </div>

            <!-- Stats Grid -->
            <div class="row mb-4">
                <div class="col col-12 col-sm-12 col-lg-6">
                    <div class="row p-3 mx-1 h-100 rounded">
                        <div class="col col-12 col-md-6">
                            <small>Total PP Rank</small>
                            <h2>#${clan.totalPPRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Average PP Rank</small>
                            <h2>#${clan.avgPPRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Ranked Score Rank</small>
                            <h2>#${clan.rankedScoreRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Accuracy Rank</small>
                            <h2>#${clan.accRank}</h2>
                        </div>
                    </div>
                </div>
                <div class="col col-12 col-sm-12 col-lg-6 mt-2 mt-lg-0">
                    <div class="p-3 mx-1 rounded h-100">
                        <table class="w-100">
                            <tbody>
                                <tr>
                                    <td>Clan created:</td>
                                    <td data-timestamp-format="date" data-timestamp="${clan.created}">${clan.created}</td>
                                </tr>
                                <tr>
                                    <td>Owner last active:</td>
                                    <td data-timestamp-format="unix" data-timestamp="${clan.ownerLastActivity?c}">${clan.ownerLastActivity?c}</td>
                                </tr>
                                <tr>
                                    <td>Members:</td>
                                    <td>${clan.members}</td>
                                </tr>
                                <tr>
                                    <td>Total PP:</td>
                                    <td>${clan.totalPP}</td>
                                </tr>
                                <tr>
                                    <td>Average PP:</td>
                                    <td>${clan.avgPP}</td>
                                </tr>
                                <tr>
                                    <td>Ranked Score:</td>
                                    <td>${clan.rankedScore}</td>
                                </tr>
                                <tr>
                                    <td>Accuracy:</td>
                                    <td>${clan.acc}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="card mx-1 mb-4" style="background: rgba(0,0,0,0.1);">
                <div class="card-header border-bottom" style="background: rgba(0,0,0,0.2);">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-users me-2"></i>Clan Members
                        <span class="badge bg-primary ms-2">${members?size}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <#list members as u>
                            <#assign index=u?index>
                            <a href="/u/${u.id?c}<#if u.mode??>?mode=${u.mode}</#if>"
                               class="list-group-item list-group-item-action member-entry <#if (index >= 8)>d-none</#if>"
                               style="background: transparent; border-color: rgba(255,255,255,0.1); transition: all 0.2s ease;">
                                <div class="d-flex align-items-center py-2">
                                    <!-- Avatar -->
                                    <div class="me-3">
                                        <div class="position-relative">
                                            <img src="${avatarServer}/${u.id?c}" 
                                                 alt="${u.name}" 
                                                 class="rounded shadow-sm" 
                                                 width="50" 
                                                 height="50"
                                                 style="object-fit: cover;">
                                            <#if u.id == clan.owner>
                                                <div class="position-absolute top-0 end-0 bg-warning rounded-circle border border-white" 
                                                     style="width: 18px; height: 18px; margin-top: -4px; margin-right: -4px;"
                                                     data-bs-toggle="tooltip" 
                                                     title="Clan Owner">
                                                    <i class="fa-solid fa-crown" style="font-size: 10px; margin-left: 3px; margin-top: 3px;"></i>
                                                </div>
                                            </#if>
                                        </div>
                                    </div>
                                    
                                    <!-- Country Flag -->
                                    <#if u.country??>
                                    <div class="me-3 d-none d-lg-block">
                                        <img src="/img/flags/${u.country}.svg" 
                                             alt="${u.country}" 
                                             class="rounded shadow-sm" 
                                             width="32" 
                                             height="24">
                                    </div>
                                    </#if>
                                    
                                    <!-- Player Name & Info -->
                                    <div class="flex-grow-1">
                                        <div class="fw-bold mb-1" style="font-size: 1.05rem;">
                                            ${u.name}
                                            <#if u.id == clan.owner>
                                                <i class="fa-solid fa-crown text-warning ms-1 d-md-none" 
                                                   data-bs-toggle="tooltip" 
                                                   title="Clan Owner"></i>
                                            </#if>
                                        </div>
                                        <div class="d-flex gap-3 small text-muted">
                                            <#if u.country??>
                                            <span class="d-lg-none">
                                                <img src="/img/flags/${u.country}.svg" 
                                                     alt="${u.country}" 
                                                     class="rounded me-1" 
                                                     width="16" 
                                                     height="12">
                                                ${u.country}
                                            </span>
                                            </#if>
                                            <span class="d-none d-sm-inline">
                                                <i class="fa-solid fa-clock me-1"></i>
                                                <span data-timestamp-format="unix" data-timestamp="${u.latestActivity?c}">
                                                    ${u.latestActivity?c}
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Stats Section -->
                                    <div class="d-none d-xl-flex gap-4 me-3">
                                        <#if u.pp??>
                                        <div class="text-center">
                                            <div class="small text-muted mb-1">PP</div>
                                            <div class="fw-bold text-info">${u.pp?string("0")}</div>
                                        </div>
                                        </#if>
                                        <#if u.rank??>
                                        <div class="text-center">
                                            <div class="small text-muted mb-1">Rank</div>
                                            <div class="fw-bold text-warning">#${u.rank?string("0")}</div>
                                        </div>
                                        </#if>
                                    </div>
                                    
                                    <!-- Arrow Icon -->
                                    <div class="text-muted ms-2">
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </div>
                                </div>
                            </a>
                        <#else>
                            <div class="list-group-item text-center py-5" style="background: transparent;">
                                <i class="fa-solid fa-users fa-3x text-muted mb-3 d-block"></i>
                                <h5 class="text-muted mb-0">No members in this clan</h5>
                                <p class="text-muted small mt-2">Be the first to join!</p>
                            </div>
                        </#list>
                    </div>
                    <#if (members?size > 8)>
                    <div class="card-footer border-top text-center" style="background: rgba(0,0,0,0.2);">
                        <button id="loadMoreBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fa-solid fa-angles-down me-2"></i>Load More Members
                        </button>
                    </div>
                    </#if>
                </div>
            </div>

            <!-- Activity Section -->
            <div class="card mx-1" style="background: rgba(0,0,0,0.1);">
                <div class="card-header border-bottom" style="background: rgba(0,0,0,0.2);">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-chart-line me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body row p-0 m-0" id="activity">
      
                        <#list activity as score>
                            <#assign index=score?index>
                            <#assign isActivity=true>
                            <#include "/freemarker/models/score.ftl">
                        </#list>
                           <#if (activity?size > 4)>
                    <div class="card-footer border-top text-center" style="background: rgba(0,0,0,0.2);">
                        <button id="loadMoreBtnAct" class="btn btn-outline-success btn-sm">
                            <i class="fa-solid fa-angles-down me-2"></i>Load More Activity
                        </button>
                    </div>
                </#if>
            
                    
                </div>
             
            </div>
            
        </div>
    </div>
</div>

<input type="hidden" id="currentCount" value="8">
<input type="hidden" id="totalMembers" value="${members?size}">
<input type="hidden" id="currentCountAct" value="4">
<input type="hidden" id="totalMembersAct" value="${activity?size}">

<#include "/assets/footer.html">
<style>
    .list-group-item-action:hover {
        background: rgba(255, 255, 255, 0.05) !important;
        transform: translateX(4px);
        border-color: rgba(255,255,255,0.2) !important;
    }
    
    .list-group-item-action {
        transition: all 0.2s ease;
    }
    
    .member-entry .badge {
        transition: all 0.3s ease;
    }
    
    .member-entry:hover .badge {
        transform: scale(1.05);
    }
    
    .member-entry img {
        transition: all 0.3s ease;
    }
    
    .member-entry:hover img {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
</style>
<script>
    // Initialize Bootstrap tooltips
    document.addEventListener('turbo:load', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    var loadMoreBtn = document.getElementById('loadMoreBtn');
    var loadMoreBtnAct = document.getElementById('loadMoreBtnAct');

    var loadMoreBtnHandler = null;
    var loadMoreBtnActHandler = null;

    function loadMoreHandler(isActivity) {
        let currentCountName = isActivity ? 'currentCountAct' : 'currentCount';
        let totalMembersName = isActivity ? 'totalMembersAct' : 'totalMembers';
        let entryName = isActivity ? 'act' : 'member';
        let loadIncrement = isActivity ? 4 : 8;

        let currentCount = parseInt(document.getElementById(currentCountName).value, 10);
        let totalMembers = parseInt(document.getElementById(totalMembersName).value, 10);

        const hiddenEntries = document.querySelectorAll('.' + entryName + '-entry.d-none');
        const limit = Math.min(hiddenEntries.length, loadIncrement);

        for (let i = 0; i < limit; i++) {
            hiddenEntries[i].classList.remove('d-none');
        }

        currentCount += limit;
        document.getElementById(currentCountName).value = currentCount;

        if (currentCount >= totalMembers || hiddenEntries.length === 0) {
            if (isActivity) {
                loadMoreBtnAct.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
    }

    function initLoadMoreButtons() {
        cleanupLoadMoreButtons();

        if (loadMoreBtn) {
            loadMoreBtnHandler = () => loadMoreHandler(false);
            loadMoreBtn.addEventListener('click', loadMoreBtnHandler);
        }

        if (loadMoreBtnAct) {
            loadMoreBtnActHandler = () => loadMoreHandler(true);
            loadMoreBtnAct.addEventListener('click', loadMoreBtnActHandler);
        }
    }

    function cleanupLoadMoreButtons() {
        if (loadMoreBtn && loadMoreBtnHandler) {
            loadMoreBtn.removeEventListener('click', loadMoreBtnHandler);
            loadMoreBtnHandler = null;
        }

        if (loadMoreBtnAct && loadMoreBtnActHandler) {
            loadMoreBtnAct.removeEventListener('click', loadMoreBtnActHandler);
            loadMoreBtnActHandler = null;
        }
    }

    document.addEventListener('turbo:load', initLoadMoreButtons);
    document.addEventListener('turbo:before-cache', cleanupLoadMoreButtons);
</script>
